/*! Conticious 06-08-2014 */
var Conticious=Ember.Application.create({createCookie:function(a,b,c){var d=null;if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}else d="";document.cookie=a+"="+b+d+"; path=/"},readCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return e.substring(b.length,e.length)}return null},eraseCookie:function(a){this.createCookie(a,"",-1)}});Conticious.CategoriesController=Ember.ArrayController.extend({needs:["category","user","subcategory"],showNewCategoryField:!1,showUploadField:!1,newCategoryName:null,newId:null,actions:{showNewCategory:function(){this.set("showNewCategoryField",!0)},cancelNewCategory:function(){this.set("showNewCategoryField",!1),this.set("newCategoryName",null)},saveNewCategory:function(){var a=this.get("newCategoryName"),b=this.store.createRecord("category",{id:a});b.save(),this.set("showNewCategoryField",!1),this.set("newCategoryName",null)},showFileUpload:function(){this.set("showUploadField",!0)},cancelFileUpload:function(){this.set("showUploadField",!1)},userChanged:function(){console.log("user changed. Refreshing categories!"),this.set("model",this.store.find("category"))},doEditSubcategory:function(){console.log("editing subcategory: "+this.get("controllers.subcategory.model.id")),this.get("controllers.subcategory.model")&&(this.set("controllers.subcategory.model.isEditing",!0),Ember.run.schedule("afterRender",function(){$("#editSubcategoryArea").hide(),$("#editSubcategoryArea").slideDown()}))},finishEditSubcategory:function(){if(console.log("finishing subcategory editing... "+this.get("newId")),this.get("controllers.subcategory.model")){var a=this;$("#editSubcategoryArea").slideUp(function(){a.set("controllers.subcategory.model.deleteFirstStep",!1),a.set("controllers.subcategory.model.isEditing",!1),a.set("newId","")})}},deleteSubcategoryFirstStep:function(a){a.set("deleteFirstStep",!0)},deleteSubcategoryConfirm:function(a){a.set("deleteFirstStep",!1),console.log("DELETING SUBCATEGORY: "+a.get("id")),this.set("controllers.subcategory.model.isEditing",!1),a.deleteRecord(),a.save(),this.transitionToRoute("categories"),controller.reloadCategories()},renameSubcategory:function(a){console.log(this.get("newId"));var b=this.get("newId");if(b&&this.get("controllers.category.model.id")){var c=b;b=this.get("controllers.category.model.id")+"_"+b;var d=this.store.createRecord("subcategory",{id:b,name:c,content:a.get("content"),fields:a.get("fields")});a.deleteRecord(),a.save(),console.log("old subcategory deleted, save new subcategory");var e=this;d.save().then(function(){e.transitionToRoute("categories"),e.reloadCategories()})}else console.log("newId is not valid: "+b)}},reloadCategories:function(){console.log("reloadCategories"),console.log(this.get("model")),this.store.find("category"),this.get("model").forEach(function(a){console.log("category: "+a.get("id")),"uploads"===a.get("id")&&a.reload()})},domainHaveUpload:function(){return void 0!==this.get("controllers.user.domain.uploadUrl")&&null!==this.get("controllers.user.domain.uploadUrl")}.property("controllers.user.domain.uploadUrl"),observeID:function(){this.send("userChanged")}.observes("controllers.user.content.id")}),Conticious.CategoriesRoute=Ember.Route.extend({model:function(){return this.store.find("category")}}),Conticious.CategoriesView=Ember.View.extend({isSelected:function(){return console.log(this.get("model.id")),console.log(this.get("controller.model.id")),console.log(this.get("controller")),console.log(this.get("context")),console.log(this),this.get("model.id")===this.get("controller.model.id")}.property("controller.model")}),Conticious.CategoryController=Ember.ObjectController.extend({}),Conticious.CategoryIndexController=Ember.Controller.extend({needs:["category","categories"],showNewFieldArea:!1,showNewSubcategoryArea:!1,showNewField:function(){return this.get("showNewFieldArea")||this.get("showNewSubcategoryArea")}.property("showNewFieldArea","showNewSubcategoryArea"),actions:{openNewField:function(){this.set("showNewFieldArea",!0)},cancelNewField:function(){this.set("showNewFieldArea",!1),this.set("newFieldName",null),this.set("newFieldType",null),this.set("newFieldRequired",!1)},openNewSubcategory:function(){this.set("showNewSubcategoryArea",!0)},cancelNewSubcategory:function(){this.set("showNewSubcategoryArea",!1),this.set("newSubcategoryName",null)},saveCategory:function(a){this.doSaveCategory(a)},saveCategoryField:function(a){a.save()},revertCategoryField:function(a){a.rollback()},deleteCategoryField:function(a){a.deleteRecord(),a.save()}},doSaveCategory:function(a){a.save();var b=a.get("defaultFields");b&&b.forEach(function(a){(a.get("isDirty")||a.get("isNew"))&&a.save()});var c=a.get("subategories");c&&c.forEach(function(a){(a.get("isDirty")||a.get("isNew"))&&a.save()})},newFieldIsAssociation:function(){return this.get("newFieldType")&&("toOne"===this.get("newFieldType")||"toMany"===this.get("newFieldType"))}.property("newFieldType"),init:function(){this._super();var a=[];a.pushObject("textarea"),a.pushObject("textfield"),a.pushObject("boolean"),a.pushObject("array"),a.pushObject("toOne"),a.pushObject("toMany"),this.set("fieldTypes",a)}}),Conticious.CategoryIndexRoute=Ember.Route.extend({actions:{addNewField:function(){var a=this.modelFor("category"),b=this.get("controller.newFieldName"),c=this.get("controller.newFieldType"),d=this.get("controller.newFieldRequired");if(b){var e=this.store.createRecord("categoryField",{id:a.get("id")+"_"+b,name:b,type:c,required:d});a.get("defaultFields").pushObject(e),e.save().then(function(){console.log("new field saved. saving category"),a.save()})}this.set("controller.newFieldName",null),this.set("controller.newFieldType",null),this.set("controller.showNewFieldArea",!1)},addNewSubcategory:function(){var a=this.modelFor("category"),b=this.get("controller.newSubcategoryName");if(b){var c=this.store.createRecord("subcategory",{id:a.get("id")+"_"+b,name:b});a.get("subcategories").pushObject(c),c.save().then(function(){console.log("newSubcategory saved. Saving category"),a.save().then(function(){a.reload(),c.reload()})})}this.set("controller.newSubcategoryName",null),this.set("controller.showNewSubcategoryArea",!1)}}}),Conticious.CategoryRoute=Ember.Route.extend({model:function(a){return this.store.find("category",a.category_id)}}),Conticious.SubcategoryFieldsController=Ember.ObjectController.extend({needs:["category"]}),Conticious.SubcategoryFieldsRoute=Ember.Route.extend({actions:{saveSubcategoryField:function(a){a.save()},revertSubcategoryField:function(a){a.rollback()}},model:function(){var a=this.modelFor("subcategory");return a}}),Conticious.SubcategoryPreviewRoute=Ember.Route.extend({model:function(){var a=this.modelFor("subcategory");return a}}),Conticious.SubcategoryIndexController=Ember.ObjectController.extend({actions:{doSaveSubcategory:function(a){console.log("doSaveSubcategory: "+a.get("id")),a.get("isDirty")&&a.save()}}}),Conticious.SubcategoryRoute=Ember.Route.extend({model:function(a){return this.store.find("subcategory",a.subcategory_id)}}),Conticious.SubcategoryIndexRoute=Ember.Route.extend({model:function(){var a=this.modelFor("subcategory");return a}}),Conticious.SubcategoryController=Ember.ObjectController.extend({}),Conticious.LogInComponent=Ember.Component.extend({actions:{loginButtonAction:function(){console.log("attempting to log in with username: "+this.get("username")+" and password: "+this.get("password"));var a={username:this.get("username"),password:this.get("password")},b=this;$.ajax({type:"POST",url:"/json/admin/auth",contentType:"application/json",data:JSON.stringify(a),success:function(a){console.log("success: "+JSON.stringify(a)),a.uuidAdminToken&&b.set("uuidAdminToken",a.uuidAdminToken)},error:function(a,b,c){console.log("error: "+JSON.stringify(a)),console.log("error: "+b+" error: "+c)}})}}}),Conticious.PopOverComponent=Ember.Component.extend({classNames:["glyphicon","glyphicon-question-sign","pull-right","popover-dismiss"],attributeBindings:["dataToggle:data-toggle","title","dataContent:data-content"],tagName:"span",didInsertElement:function(){var a=this.get("elementId");$("#"+a).popover({trigger:"hover"})}}),Conticious.SelectMultipleComponent=Ember.Component.extend({actions:{addItem:function(){var a=this.get("selectedValue"),b=this.get("addedItems");console.log("selectedValue: "+a),console.log("addedItems: "+b),b||(b=[],this.set("addedItems",b)),b.pushObject(a),this.get("model").send("becomeDirty"),console.log("addedItems: "+b)},deleteItem:function(a){console.log("deleteItem: "+a),a&&(this.get("addedItems").removeObject(a),this.get("model").send("becomeDirty"))}}}),Conticious.HeaderController=Ember.Controller.extend({needs:["user"],actions:{logOut:function(){Conticious.eraseCookie("uuidAdminToken"),this.set("controllers.user.uuidAdminToken",null),Conticious.reset()}}}),Conticious.Category=DS.Model.extend({subcategories:DS.hasMany("subcategory"),defaultFields:DS.hasMany("categoryField"),isPublic:DS.attr("boolean")}),Conticious.CategoryField=DS.Model.extend({name:DS.attr("string"),type:DS.attr("string"),required:DS.attr("boolean"),relation:DS.attr("string"),isTextfield:function(){return"textfield"===this.get("type")}.property("type"),isTextarea:function(){return"textarea"===this.get("type")}.property("type"),isBoolean:function(){return"boolean"===this.get("type")}.property("type"),isToOne:function(){return"toOne"===this.get("type")}.property("type"),isToMany:function(){return"toMany"===this.get("type")}.property("type")}),Conticious.Domain=DS.Model.extend({domainName:DS.attr("string"),webappName:DS.attr("string"),active:DS.attr("boolean"),minified:DS.attr("boolean"),uploadUrl:DS.attr("string"),uploadPath:DS.attr("string"),createCategory:DS.attr("string")}),Conticious.Setting=DS.Model.extend({domains:DS.hasMany("domain")}),Conticious.Subcategory=DS.Model.extend({name:DS.attr("string"),content:DS.attr("string"),fields:DS.hasMany("subcategoryField")}),Conticious.SubcategoryField=DS.Model.extend({name:DS.attr("string"),type:DS.attr("string"),required:DS.attr("boolean"),value:DS.attr("string"),relation:DS.belongsTo("category"),relations:DS.hasMany("subcategory",{async:!0}),isTextfield:function(){return"textfield"===this.get("type")}.property("type"),isTextarea:function(){return"textarea"===this.get("type")}.property("type"),isBoolean:function(){return"boolean"===this.get("type")}.property("type"),isArray:function(){return"array"===this.get("type")}.property("type"),isToOne:function(){return"toOne"===this.get("type")}.property("type"),isToMany:function(){return"toMany"===this.get("type")}.property("type")}),Conticious.User=DS.Model.extend({username:DS.attr("string"),role:DS.attr("string")}),Conticious.Router.map(function(){this.resource("categories",{path:"/"},function(){this.resource("category",{path:"/category/:category_id"},function(){this.resource("subcategory",{path:"/subcategory/:subcategory_id"},function(){this.route("fields"),this.route("preview")})})}),this.resource("setting")}),Conticious.SettingController=Ember.ObjectController.extend({needs:["user"],actions:{addDomain:function(){var a=this.get("domains"),b=this.store.createRecord("domain",{});a.pushObject(b)},deleteDomain:function(a){a.deleteRecord(),this.get("model.domains").removeObject(a)},saveChanges:function(){this.doSaveSettings()},userChanged:function(){console.log("user changed. Refreshing settings!"),this.get("model").reload()},generateStatic:function(a){var b=(location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),{});b.hostname=window.location.hostname,b.port=location.port?location.port:"",b.domain=a.get("domainName"),console.log("hostname: "+window.location.hostname),console.log("port: "),$.ajax("/json/admin/spg/"+a.get("domainName"),{data:JSON.stringify(b),contentType:"application/json",type:"POST",success:function(){console.log("SUCCESS")}})}},doSaveSettings:function(){var a=[];this.get("model.domains").forEach(function(b){a.pushObject(b)});var b={};b.domains=a;var c=this;$.ajax("/json/admin/settings",{data:JSON.stringify(b),contentType:"application/json",type:"POST",success:function(){console.log("SUCCESS"),console.log(c.get("model")),c.get("model").reload()}})},observeID:function(){this.send("userChanged")}.observes("controllers.user.content.id")}),Conticious.SettingRoute=Ember.Route.extend({model:function(){return this.store.find("setting","ConticiousSettings")}}),DS.RESTAdapter.reopen({namespace:"json/admin"}),Conticious.Store=DS.Store.extend({adapter:"DS.RESTAdapter"}),Conticious.UserController=Ember.Controller.extend({init:function(){console.log("UserController init");var a=Conticious.readCookie("uuidAdminToken");a&&this.set("uuidAdminToken",a)},uuidObserver:function(){if(console.log("uuidAdminTokenObserver: "+this.get("uuidAdminToken")),this.get("uuidAdminToken")){console.log("Fetching Admin User");var a=this;this.store.find("user",this.get("uuidAdminToken")).then(function(b){"admin"===b.get("role")||"super"===b.get("role")?(console.log("Creating uuidAdminToken cookie!"),Conticious.createCookie("uuidAdminToken",b.get("id"),30),a.set("content",b),a.store.find("setting","ConticiousSettings").then(function(b){b.get("domains")&&b.get("domains").forEach(function(b){b.get("id")===window.location.hostname&&a.set("domain",b)})})):(console.log("UUID Token is no longer valid, erasing cookie!"),Conticious.eraseCookie("uuidAdminToken"))})}}.observes("uuidAdminToken").on("init"),isAdminLoggedIn:function(){var a=!1;return console.log("roleObserver: "+this.get("content.role")),("admin"===this.get("content.role")||"super"===this.get("content.role"))&&(a=!0),a}.property("content.role")}),Conticious.FileReaderView=Ember.View.extend({tagName:"input",attributeBindings:["type","id","name"],type:"file",didInsertElement:function(){var a=this;Ember.run.schedule("afterRender",function(){var b=$("#uploadFileButton"),c=a.get("controller.controllers.user.domain.uploadUrl");$("#"+a.get("elementId")).fileupload({url:c,dataType:"json",add:function(a,c){$("#progressText").html("Uploading: "+c.files[0].name),b.click(function(){c.submit()})},done:function(b,c){console.log("done"),console.log(c),console.log(c.result.filename),$("#progress .bar").css("width","0%"),console.log("Reloading Uploads"),$("#progressText").html("Done: "+c.files[0].name),a.get("controller").reloadCategories()},progressall:function(a,b){console.log("progressall"),console.log(b);var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")})}}),Conticious.MarkdownTextArea=Ember.TextArea.extend({didInsertElement:function(){var a=this.get("elementId");$("#"+a).markdown({autofocus:!1,savable:!1})}}),Conticious.MenuCategoryView=Ember.View.extend({templateName:"menu-category",selectedSortColumn:null,selectedFilterString:null,selectedFilterColumn:null,sortAndFilterShowing:!1,numSubcategoriesShown:0,showNewSubcategoryArea:!1,newSubcategoryName:null,actions:{toggleSortAndFilter:function(){if(this.get("sortAndFilterShowing")){var a=this;$("#sortAndFilterArea").slideUp(function(){a.set("sortAndFilterShowing",!1)})}else this.set("sortAndFilterShowing",!0),Ember.run.schedule("afterRender",function(){$("#sortAndFilterArea").hide(),$("#sortAndFilterArea").slideDown()});console.log("toggleSortAndFilter: "+this.get("sortAndFilterShowing"))},openNewSubcategory:function(){this.get("showNewSubcategoryArea")||(this.set("showNewSubcategoryArea",!0),Ember.run.schedule("afterRender",function(){$("#showNewSubcategoryArea").hide(),$("#showNewSubcategoryArea").slideDown()}))},cancelNewSubcategory:function(){this.hideAddSubcategory()},addNewSubcategory:function(){var a=this.get("category"),b=this.get("newSubcategoryName");if(b){var c=this.get("controller").store.createRecord("subcategory",{id:a.get("id")+"_"+b,name:b});a.get("subcategories").pushObject(c),c.save().then(function(){console.log("newSubcategory saved. Saving category"),a.save().then(function(){a.reload(),c.reload()})})}this.hideAddSubcategory()}},hideAddSubcategory:function(){var a=this;$("#showNewSubcategoryArea").slideUp(function(){a.set("showNewSubcategoryArea",!1),a.set("newSubcategoryName",null)})},isSelected:function(){return this.get("category.id")===this.get("controller.controllers.category.model.id")}.property("controller.controllers.category.model.id"),selectedSortColumnObserver:function(){console.log("New Sort Columnn: "+this.get("selectedSortColumn")),this.sortOrFilter()}.observes("selectedSortColumn"),selectedFilterStringObserver:function(){console.log("New Filter String: "+this.get("selectedFilterString")),this.sortOrFilter()}.observes("selectedFilterString"),selectedFilterColumnObserver:function(){console.log("New Filter Column: "+this.get("selectedFilterColumn")),this.sortOrFilter()}.observes("selectedFilterColumn"),subcategoriesObserver:function(){this.set("sortedSubcategories",this.get("category.subcategories"))}.observes("category.subcategories").on("init"),sortOrFilter:function(){console.log("Sorting subcategories");var a=this.get("selectedSortColumn"),b=this.get("selectedFilterColumn"),c=this.get("selectedFilterString"),d=[],e="id";a&&d&&(e="sortValue"),this.get("category.subcategories").forEach(function(e){var f=!0;e.get("fields").forEach(function(d){d.get("name")===a&&e.set("sortValue",d.get("value")),b&&c&&d.get("name")===b?(f=d.get("value")&&d.get("value").indexOf(c)>-1,console.log("    Filtering away: "+e.get("id"))):null===b&&c&&(f=e.get("id").indexOf(c)>-1)}),a||e.set("sortValue",e.get("id")),f&&d.push(e)}),console.log("sortProp: "+e),console.log(e);var f=Em.ArrayProxy.createWithMixins(Ember.SortableMixin,{content:d,sortProperties:["sortValue"]});console.log(f.getEach("id")),this.set("numSubcategoriesShown",d.get("length")),this.set("sortedSubcategories",f)},sortedSubcategoriesObserver:function(){}.observes("sortedSubcategories.@each.id")}),Conticious.MenuSubcategoryView=Ember.View.extend({templateName:"menu-subcategory",isSelected:function(){return this.get("subcategory.id")===this.get("controller.controllers.subcategory.model.id")}.property("controller.controllers.subcategory.model.id"),isEditing:function(){return this.get("isSelected")&&this.get("subcategory.isEditing")}.property("isSelected","subcategory.isEditing"),didInsertElement:function(){$("#"+this.get("elementId")).hide().slideDown()}});